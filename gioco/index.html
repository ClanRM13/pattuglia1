<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>Scopri la tua pattuglia!</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      /* grandezza pulsanti touch: max 18% larghezza viewport oppure 80px */
      --btn-size:min(18vw,80px);
    }
    html,body{
      margin:0;padding:0;width:100%;height:100%;
      overflow:hidden;
      touch-action:none;            /* evita lo scroll/zoom accidentale */
      -webkit-user-select:none;     /* disattiva selezione testo su iOS */
      user-select:none;
      background:#000;
    }

    /* Canvas: riempi la larghezza mantenendo il rapporto 4:3 */
    canvas{
      display:block;margin:0 auto;
      width:100vw;                 /* sempre la larghezza piena */
      height:auto;                 /* altezza calcolata dal browser */
      max-height:100vh;            /* non oltre l’altezza della viewport */
      aspect-ratio:4/3;
      object-fit:contain;
      touch-action:none;
    }

    /* Overlay di avvio / messaggi */
    #overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.6);z-index:3;
      font-family:'Press Start 2P',monospace;color:#ff0;
      text-shadow:2px 2px 0 #000;
      padding:4vw;text-align:center;
    }
    #logo{width:40vw;max-width:180px;margin-bottom:4vh;}

    /* Immagine di sfondo del menu  (scomparirà quando il gioco parte) */
    body::before{
      content:"";position:fixed;inset:0;
      background:url('backgroundmenu.png') center/cover no-repeat;
      z-index:1;
    }
    body.game-started::before{display:none;}

    /* Pulsanti touch */
    #touchControls{
      position:fixed;bottom:calc(4vh + env(safe-area-inset-bottom));left:5vw;
      display:flex;gap:5vw;z-index:4;
    }
    .touchBtn{
      width:var(--btn-size);height:var(--btn-size);
      font-family:'Press Start 2P',monospace;
      font-size:clamp(14px,4vw,24px);
      background:rgba(255,255,255,0.85);
      border:2px solid #ffa500;border-radius:15%;
      box-shadow:0 0 10px #ffa500;
      display:flex;align-items:center;justify-content:center;
      line-height:1;touch-action:none;
    }
    #jumpBtn{
      position:fixed;bottom:calc(4vh + env(safe-area-inset-bottom));right:5vw;z-index:4;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="600"></canvas>

  <!-- overlay di testo / logo -->
  <div id="overlay">
    <img id="logo" src="logo.png" alt="Logo">
    <div id="overlayText">Tocca lo schermo o premi un tasto<br>per iniziare</div>
  </div>

  <!-- controlli virtuali -->
  <div id="touchControls">
    <button id="leftBtn"  class="touchBtn" aria-label="sinistra">←</button>
    <button id="rightBtn" class="touchBtn" aria-label="destra">→</button>
  </div>
  <button id="jumpBtn" class="touchBtn" aria-label="salta">↑</button>

  <!-- audio -->
  <audio id="bgMusic"    src="musica.mp3" loop></audio>
  <audio id="hitSound"    src="bounch.mp3"></audio>
  <audio id="winnerSound" src="winner.mp3"></audio>

  <script>
    (function(){
      /* =========================================================
         CANVAS & COSTANTI                                         
      ========================================================= */
      const canvas  = document.getElementById('gameCanvas');
      const ctx     = canvas.getContext('2d');
      const DPR     = window.devicePixelRatio || 1; // retina fix
      // scala per schermi ad alta densità mantenendo 800×600 logici
      canvas.width  = 800 * DPR;
      canvas.height = 600 * DPR;
      ctx.scale(DPR, DPR);

      /* DOM */
      const overlay      = document.getElementById('overlay');
      const overlayText  = document.getElementById('overlayText');
      const leftBtn      = document.getElementById('leftBtn');
      const rightBtn     = document.getElementById('rightBtn');
      const jumpBtn      = document.getElementById('jumpBtn');
      const bgMusic      = document.getElementById('bgMusic');
      const hitSound     = document.getElementById('hitSound');
      const winnerSound  = document.getElementById('winnerSound');

      /* SPRITES */
      const imgBackground   = new Image(); imgBackground.src   = 'background.png';
      const imgPlayerRight  = new Image(); imgPlayerRight.src  = 'player.png';
      const imgPlayerLeft   = new Image(); imgPlayerLeft.src   = 'player2.png';
      const imgScarpa       = new Image(); imgScarpa.src       = 'scarpa.png';
      const imgRover        = new Image(); imgRover.src        = 'rover1.png';
      const bossLeftImages  = [null,new Image(),new Image(),new Image()];
      const bossRightImages = [null,new Image(),new Image(),new Image()];
      bossLeftImages[1].src  = 'boss12.png';  bossRightImages[1].src = 'boss1.png';
      bossLeftImages[2].src  = 'boss2.png';   bossRightImages[2].src = 'boss22.png';
      bossLeftImages[3].src  = 'boss3.png';   bossRightImages[3].src = 'boss32.png';

      /* INPUT -------------------------------------------------- */
      const keys = {};
      window.addEventListener('keydown', e => {
        keys[e.code] = true;
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault();
      });
      window.addEventListener('keyup', e => { keys[e.code] = false; });

      // helper per associare un pulsante virtuale a un keyCode
      function bindVirtualButton(btn, code){
        btn.addEventListener('pointerdown', e => {
          if(e.pointerType === 'touch' || e.pointerType === 'pen'){
            e.preventDefault();
            keys[code] = true;
          }
        }, { passive:false });
        const clear = () => { keys[code] = false; };
        btn.addEventListener('pointerup',     clear);
        btn.addEventListener('pointercancel', clear);
        btn.addEventListener('pointerleave',  clear);
      }
      bindVirtualButton(leftBtn,  'ArrowLeft');
      bindVirtualButton(rightBtn, 'ArrowRight');
      bindVirtualButton(jumpBtn,  'Space'); // Space = salto nel codice giocatore

      /* GIOCO -------------------------------------------------- */
      const GRAVITY    = 0.6;
      const JUMP_FORCE = 16;

      class Player{
        constructor(){
          this.w = 60; this.h = 90;
          this.x = 100; this.y = canvas.height / DPR - this.h - 10;
          this.vy = 0; this.speed = 5; this.onGround = false;
          this.direction = 'right';
        }
        update(){
          if(keys['ArrowLeft'] && this.x > 0){ this.x -= this.speed; this.direction = 'left'; }
          if(keys['ArrowRight'] && this.x + this.w < canvas.width / DPR){ this.x += this.speed; this.direction = 'right'; }
          if((keys['ArrowUp'] || keys['Space']) && this.onGround){ this.vy = -JUMP_FORCE; this.onGround = false; }
          this.vy += GRAVITY; this.y += this.vy;
          const groundY = canvas.height / DPR - this.h - 10;
          if(this.y >= groundY){ this.y = groundY; this.vy = 0; this.onGround = true; }
          // evita salto infinito usando Space (rilasciato dallo script bindVirtualButton)
        }
        draw(){
          const img = this.direction === 'left' ? imgPlayerLeft : imgPlayerRight;
          if(img.complete) ctx.drawImage(img, this.x, this.y, this.w, this.h);
          else{ ctx.fillStyle = 'lime'; ctx.fillRect(this.x, this.y, this.w, this.h); }
        }
      }

      class Scarpa{
        constructor(x,y,dir){
          this.w = 48; this.h = 48;
          this.x = x - this.w/2; this.y = y - this.h/2;
          this.dx = dir * 8 + (Math.random()*1.5-0.75);
          this.dy = -10 + (Math.random()*1.5-0.75);
          this.gravity = 0.2; this.active = true;
        }
        update(){
          this.dy += this.gravity; this.x += this.dx; this.y += this.dy;
          if(this.x < -this.w || this.x > canvas.width / DPR || this.y > canvas.height / DPR) this.active = false;
        }
        draw(){
          if(imgScarpa.complete) ctx.drawImage(imgScarpa, this.x, this.y, this.w, this.h);
          else { ctx.fillStyle = 'brown'; ctx.fillRect(this.x, this.y, this.w, this.h); }
        }
        collidesWith(p){
          return this.x < p.x + p.w && this.x + this.w > p.x && this.y < p.y + p.h && this.y + this.h > p.y;
        }
      }

      class Boss{
        constructor(level){
          this.level = level; this.w = 150; this.h = 150;
          this.x = canvas.width / DPR - this.w - 100; this.y = canvas.height / DPR - this.h - 10;
          this.dx = 2 + level; this.vy = 0; this.onGround = true;
          this.maxHp = (level === 3 ? 3 : 3 + level);
          this.hp    = this.maxHp;
          this.invincibleTimer = 0; this.jumpCooldown = 0; this.hitCount = 0;
        }
        update(){
          this.x += this.dx;
          if(this.x <= 0 || this.x + this.w >= canvas.width / DPR) this.dx *= -1;
          this.vy += GRAVITY; this.y += this.vy;
          const groundY = canvas.height / DPR - this.h - 10;
          if(this.y >= groundY){ this.y = groundY; this.vy = 0; this.onGround = true; } else this.onGround = false;
          if(this.level === 2 && this.onGround){ this.jumpCooldown--; if(this.jumpCooldown <= 0){ this.vy = -12; this.jumpCooldown = 120; }}
          if(this.level === 3){ if(Math.random() < 0.01) this.dx *= -1; if(this.onGround && Math.random() < 0.02) this.vy = -12; }
          if((this.level === 1 && this.hp <= this.maxHp/2) || (this.hitCount >= (this.level === 3 ? 1 : 2))){
            if(!scarpaAttiva){ const dir = this.dx < 0 ? -1 : 1; scarpaAttiva = new Scarpa(this.x + this.w/2, this.y + this.h/2, dir); this.hitCount = 0; }
          }
          if(this.invincibleTimer > 0) this.invincibleTimer--;
        }
        draw(){
          const img = this.dx < 0 ? bossLeftImages[this.level] : bossRightImages[this.level];
          if(img.complete) ctx.drawImage(img, this.x, this.y, this.w, this.h);
          else{ ctx.fillStyle = 'red'; ctx.fillRect(this.x, this.y, this.w, this.h); }

          // barra HP
          const hpW = this.w * (this.hp / this.maxHp);
          ctx.fillStyle = 'darkred'; ctx.fillRect(this.x, this.y - 10, this.w, 5);
          ctx.fillStyle = 'lime';    ctx.fillRect(this.x, this.y - 10, hpW, 5);
        }
      }

      /* VARIABILI GIOCO --------------------------------------- */
      let level = 1, MAX_LEVEL = 3;
      let player = new Player(), boss = new Boss(level), scarpaAttiva = null, running = false;

      function resetLevel(){ player = new Player(); boss = new Boss(level); scarpaAttiva = null; }
      function showOverlayText(msg){ overlayText.innerHTML = msg; overlay.style.display = 'flex'; }

      function startGame(){
        overlay.style.display = 'none';
        document.body.classList.add('game-started');
        bgMusic.play().catch(()=>{});
        requestFullscreen();
        running = true;
        requestAnimationFrame(gameLoop);
      }

      /* esperienza full‑screen */
      function requestFullscreen(){
        const el = document.documentElement;
        if(el.requestFullscreen){ el.requestFullscreen().catch(()=>{}); }
      }

      function showStartOverlay(){
        showOverlayText('Tocca lo schermo o premi un tasto<br>per iniziare');
        const startOnce = { once:true };
        overlay.addEventListener('pointerdown', startGame, startOnce);
        overlay.addEventListener('mousedown',   startGame, startOnce);
        window.addEventListener('keydown',      startGame, startOnce);
      }

      function showVictoryAndAdvance(){
        winnerSound.play().catch(()=>{});
        const names = {1:'Lorenzo P.',2:'Karim',3:'Lorenzo Cap.'};
        imgRover.src = `rover${level}.png`;
        showOverlayText(`Hai liberato ${names[level]}!`);
        setTimeout(()=>{
          let roverX = canvas.width / DPR + 120;
          function animateRover(){
            if(!running)return;
            if(imgBackground.complete) ctx.drawImage(imgBackground,0,0,canvas.width / DPR,canvas.height / DPR);
            else { ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width / DPR,canvas.height / DPR); }
            player.draw(); boss.draw();
            if(imgRover.complete) ctx.drawImage(imgRover, roverX, canvas.height / DPR - 120, 120, 120);
            roverX -= 5;
            if(roverX + 120 > 0) requestAnimationFrame(animateRover);
            else{
              level++;
              if(level > MAX_LEVEL) showOverlayText('🎉 Complimenti!<br>Hai completato il gioco!');
              else { resetLevel(); running = true; requestAnimationFrame(gameLoop); }
            }
          }
          running = true; requestAnimationFrame(animateRover);
        },2000);
      }

      /* collisione player-boss */
      function handlePlayerBossCollision(){
        if(!(player.x < boss.x + boss.w && player.x + player.w > boss.x && player.y < boss.y + boss.h && player.y + player.h > boss.y)) return;
        const topHit = player.vy > 0 && player.y + player.h - player.vy <= boss.y + 10;
        if(topHit && boss.invincibleTimer === 0){
          boss.hp--; boss.invincibleTimer = 30; boss.hitCount++;
          player.vy = -JUMP_FORCE * 0.8; player.y = boss.y - player.h - 1;
          boss.dx = -Math.abs(boss.dx * 1.1);
          hitSound.currentTime = 0; hitSound.play().catch(()=>{});
        }else if(!topHit && boss.invincibleTimer === 0){
          running = false;
          showOverlayText('Sei stato sconfitto!<br>Riprova...');
          setTimeout(()=>{ resetLevel(); running = true; requestAnimationFrame(gameLoop); startGame(); }, 2000);
        }
      }

      /* GAMeloop */
      function gameLoop(){
        if(!running) return;
        if(imgBackground.complete) ctx.drawImage(imgBackground,0,0,canvas.width / DPR,canvas.height / DPR);
        else { ctx.fillStyle='#111'; ctx.fillRect(0,0,canvas.width / DPR,canvas.height / DPR); }

        player.update(); boss.update(); handlePlayerBossCollision();

        // scarpa
        if(scarpaAttiva){
          scarpaAttiva.update();
          if(scarpaAttiva.collidesWith(player)){
            running = false;
            showOverlayText('Lo scarpone ti ha colpito!<br>Riprova...');
            setTimeout(()=>{ resetLevel(); running = true; requestAnimationFrame(gameLoop); startGame(); }, 2000);
          }
          scarpaAttiva.draw();
          if(!scarpaAttiva.active) scarpaAttiva = null;
        }

        player.draw(); boss.draw();

        if(boss.hp <= 0){ running = false; showVictoryAndAdvance(); return; }
        requestAnimationFrame(gameLoop);
      }

      /* pre‑load asset & avvio */
      function assetsReady(){
        return imgPlayerRight.complete && imgPlayerLeft.complete &&
               bossLeftImages[1].complete && bossLeftImages[2].complete && bossLeftImages[3].complete &&
               bossRightImages[1].complete && bossRightImages[2].complete && bossRightImages[3].complete &&
               imgBackground.complete && imgScarpa.complete && imgRover.complete;
      }
      const preload = setInterval(()=>{ if(assetsReady()){ clearInterval(preload); showStartOverlay(); } }, 100);

      /* ridimensionamento viewport/orientamento */
      window.addEventListener('resize', () => {
        // il canvas HTML (NON il buffer) è fluido grazie a width:100vw via CSS
        // nulla da fare qui, ma potresti ricalcolare coordinate se usassi world<>screen diversi
      });

    })();
  </script>
</body>
</html>